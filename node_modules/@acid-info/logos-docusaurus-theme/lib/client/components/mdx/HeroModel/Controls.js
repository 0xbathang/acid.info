"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Controls = void 0;
const tslib_1 = require("tslib");
const HeroModel_configs_1 = require("./HeroModel.configs");
const react_1 = tslib_1.__importStar(require("react"));
const useScrollY_1 = require("../../../lib/useScrollY");
const fiber_1 = require("@react-three/fiber");
const drei_1 = require("@react-three/drei");
const ui_utils_1 = require("../../../lib/ui.utils");
const lerp = (a, b, t) => (1 - t) * a + t * b;
let targetPos = [0, 0, 0];
// function calculateCameraPosition(scrollY: number): [number, number, number] {
//   const baseXZ = -1.6 // Base x and z component at scrollY = 0
//   const baseY = 4.04 // Base y component at scrollY = 0
//   const rateXZ = -0.01 // Rate of change for x and z components
//   const rateY = 0.00185 // Rate of change for y component
//   const deltaX = baseXZ + rateXZ * scrollY - baseXZ
//   const deltaY = baseY + rateY * scrollY - baseY
//   const deltaZ = baseXZ + rateXZ * scrollY - baseXZ
//   return [deltaX, deltaY, deltaZ]
// }
const MAX_SCROLL = 400;
function calculateVector(scrollY, scrollYMax, preset, target) {
    // Calculate the lerp factor based on the scroll position
    const t = Math.min(scrollY, scrollYMax) / scrollYMax;
    const newVector = [0, 0, 0];
    for (let i = 0; i < 3; i++) {
        // Perform a lerp between the preset and target for each component
        // @ts-ignore
        newVector[i] = lerp(preset[i], target[i], t);
    }
    return newVector;
}
const Controls = ({ rotateSpeed = HeroModel_configs_1.ROTATE_SPEED, enableZoom = true, enableRotateOnScroll = true, preset, targetPreset, children, ...props }) => {
    const ref = (0, react_1.useRef)();
    const scrollY = (0, useScrollY_1.useScrollY)();
    const { camera, size } = (0, fiber_1.useThree)();
    const controls = (0, react_1.useRef)();
    const [lockOrbit, setLockOrbit] = react_1.default.useState(false);
    const [scale, setScale] = react_1.default.useState(1);
    const [posY, setPosY] = react_1.default.useState(0);
    (0, fiber_1.useFrame)((state, delta) => {
        ref.current.rotation.y -=
            delta * ((0, ui_utils_1.isMobile)() ? 0.6 * rotateSpeed : rotateSpeed);
    });
    (0, react_1.useEffect)(() => {
        const onClick = () => {
            console.log(JSON.stringify({
                cameraPos: camera.position.toArray(),
                cameraRot: camera.rotation.toArray().slice(0, 3),
                controlsTarget: controls.current.target.toArray(),
            }, null, 2));
        };
        window.addEventListener('click', onClick);
        return () => window.removeEventListener('click', onClick);
    }, [camera]);
    (0, react_1.useEffect)(() => {
        if ((0, ui_utils_1.isTouchDevice)()) {
            controls.current.minPolarAngle = Math.PI / 2;
            controls.current.maxPolarAngle = Math.PI / 2;
            setTimeout(() => {
                setLockOrbit(true);
            }, 1000);
        }
    }, []);
    (0, react_1.useEffect)(() => {
        if ((0, ui_utils_1.isMobile)()) {
            setScale((0, ui_utils_1.mapFloat)(scrollY, 0, (0, ui_utils_1.calcScrollThreshold)(), 1, 0.65));
            setPosY((0, ui_utils_1.mapFloat)(scrollY, 0, (0, ui_utils_1.calcScrollThreshold)(), 0, 0.35));
        }
    }, [scrollY]);
    (0, react_1.useEffect)(() => {
        if (!enableZoom)
            return;
        if (!targetPreset)
            return;
        // we only apply zoom effect if targetPreset is defined
        const newPos = calculateVector(scrollY, MAX_SCROLL, preset.cameraPos, targetPreset.cameraPos);
        const newRot = calculateVector(scrollY, MAX_SCROLL, preset.cameraRot, targetPreset.cameraRot);
        const newTarget = calculateVector(scrollY, MAX_SCROLL, preset.controlsTarget, targetPreset.controlsTarget);
        camera.position.set(...newPos);
        camera.rotation.set(...newRot);
        controls.current.target.set(...newTarget);
        camera.updateProjectionMatrix();
    }, [scrollY, camera]);
    return (react_1.default.createElement("group", { ref: ref, ...props, scale: scale, "position-y": posY },
        children,
        react_1.default.createElement(drei_1.OrbitControls, { ref: controls, enableZoom: false, target: controls.current ? controls.current.target : preset.controlsTarget, enabled: !lockOrbit })));
};
exports.Controls = Controls;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGllbnQvY29tcG9uZW50cy9tZHgvSGVyb01vZGVsL0NvbnRyb2xzLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsMkRBQWtEO0FBRWxELHVEQUFnRDtBQUNoRCx3REFBb0Q7QUFDcEQsOENBQXVEO0FBQ3ZELDRDQUFpRDtBQUNqRCxvREFLOEI7QUFFOUIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFTLEVBQUUsQ0FBUyxFQUFFLENBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDckUsSUFBSSxTQUFTLEdBQTZCLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtBQUVuRCxnRkFBZ0Y7QUFDaEYsaUVBQWlFO0FBQ2pFLDBEQUEwRDtBQUMxRCxrRUFBa0U7QUFDbEUsNERBQTREO0FBQzVELHNEQUFzRDtBQUN0RCxtREFBbUQ7QUFDbkQsc0RBQXNEO0FBQ3RELG9DQUFvQztBQUNwQyxJQUFJO0FBRUosTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFBO0FBRXRCLFNBQVMsZUFBZSxDQUN0QixPQUFlLEVBQ2YsVUFBa0IsRUFDbEIsTUFBZ0IsRUFDaEIsTUFBZ0I7SUFFaEIseURBQXlEO0lBQ3pELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxHQUFHLFVBQVUsQ0FBQTtJQUVwRCxNQUFNLFNBQVMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDM0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMxQixrRUFBa0U7UUFDbEUsYUFBYTtRQUNiLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFF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S0FBTSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssZ0JBQWMsSUFBSTtRQUN2RCxRQUFRO1FBQ1QsOEJBQUMsb0JBQWEsSUFDWixHQUFHLEVBQUUsUUFBUSxFQUNiLFVBQVUsRUFBRSxLQUFLLEVBQ2pCLE1BQU0sRUFDSixRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLGNBQWMsRUFFcEUsT0FBTyxFQUFFLENBQUMsU0FBUyxHQUNuQixDQUNJLENBQ1QsQ0FBQTtBQUNILENBQUMsQ0FBQTtBQXRHWSxRQUFBLFFBQVEsWUFzR3BCIiwiZmlsZSI6ImNsaWVudC9jb21wb25lbnRzL21keC9IZXJvTW9kZWwvQ29udHJvbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBST1RBVEVfU1BFRUQgfSBmcm9tICcuL0hlcm9Nb2RlbC5jb25maWdzJ1xuaW1wb3J0IHsgTW92ZW1lbnRQcm9wcyB9IGZyb20gJy4uLy4uLy4uL3R5cGVzL3VpLnR5cGVzJ1xuaW1wb3J0IFJlYWN0LCB7IHVzZUVmZmVjdCwgdXNlUmVmIH0gZnJvbSAncmVhY3QnXG5pbXBvcnQgeyB1c2VTY3JvbGxZIH0gZnJvbSAnLi4vLi4vLi4vbGliL3VzZVNjcm9sbFknXG5pbXBvcnQgeyB1c2VGcmFtZSwgdXNlVGhyZWUgfSBmcm9tICdAcmVhY3QtdGhyZWUvZmliZXInXG5pbXBvcnQgeyBPcmJpdENvbnRyb2xzIH0gZnJvbSAnQHJlYWN0LXRocmVlL2RyZWknXG5pbXBvcnQge1xuICBjYWxjU2Nyb2xsVGhyZXNob2xkLFxuICBpc01vYmlsZSxcbiAgaXNUb3VjaERldmljZSxcbiAgbWFwRmxvYXQsXG59IGZyb20gJy4uLy4uLy4uL2xpYi91aS51dGlscydcblxuY29uc3QgbGVycCA9IChhOiBudW1iZXIsIGI6IG51bWJlciwgdDogbnVtYmVyKSA9PiAoMSAtIHQpICogYSArIHQgKiBiXG5sZXQgdGFyZ2V0UG9zOiBbbnVtYmVyLCBudW1iZXIsIG51bWJlcl0gPSBbMCwgMCwgMF1cblxuLy8gZnVuY3Rpb24gY2FsY3VsYXRlQ2FtZXJhUG9zaXRpb24oc2Nyb2xsWTogbnVtYmVyKTogW251bWJlciwgbnVtYmVyLCBudW1iZXJdIHtcbi8vICAgY29uc3QgYmFzZVhaID0gLTEuNiAvLyBCYXNlIHggYW5kIHogY29tcG9uZW50IGF0IHNjcm9sbFkgPSAwXG4vLyAgIGNvbnN0IGJhc2VZID0gNC4wNCAvLyBCYXNlIHkgY29tcG9uZW50IGF0IHNjcm9sbFkgPSAwXG4vLyAgIGNvbnN0IHJhdGVYWiA9IC0wLjAxIC8vIFJhdGUgb2YgY2hhbmdlIGZvciB4IGFuZCB6IGNvbXBvbmVudHNcbi8vICAgY29uc3QgcmF0ZVkgPSAwLjAwMTg1IC8vIFJhdGUgb2YgY2hhbmdlIGZvciB5IGNvbXBvbmVudFxuLy8gICBjb25zdCBkZWx0YVggPSBiYXNlWFogKyByYXRlWFogKiBzY3JvbGxZIC0gYmFzZVhaXG4vLyAgIGNvbnN0IGRlbHRhWSA9IGJhc2VZICsgcmF0ZVkgKiBzY3JvbGxZIC0gYmFzZVlcbi8vICAgY29uc3QgZGVsdGFaID0gYmFzZVhaICsgcmF0ZVhaICogc2Nyb2xsWSAtIGJhc2VYWlxuLy8gICByZXR1cm4gW2RlbHRhWCwgZGVsdGFZLCBkZWx0YVpdXG4vLyB9XG5cbmNvbnN0IE1BWF9TQ1JPTEwgPSA0MDBcblxuZnVuY3Rpb24gY2FsY3VsYXRlVmVjdG9yKFxuICBzY3JvbGxZOiBudW1iZXIsXG4gIHNjcm9sbFlNYXg6IG51bWJlcixcbiAgcHJlc2V0OiBudW1iZXJbXSxcbiAgdGFyZ2V0OiBudW1iZXJbXSxcbik6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyXSB7XG4gIC8vIENhbGN1bGF0ZSB0aGUgbGVycCBmYWN0b3IgYmFzZWQgb24gdGhlIHNjcm9sbCBwb3NpdGlvblxuICBjb25zdCB0ID0gTWF0aC5taW4oc2Nyb2xsWSwgc2Nyb2xsWU1heCkgLyBzY3JvbGxZTWF4XG5cbiAgY29uc3QgbmV3VmVjdG9yID0gWzAsIDAsIDBdXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgaSsrKSB7XG4gICAgLy8gUGVyZm9ybSBhIGxlcnAgYmV0d2VlbiB0aGUgcHJlc2V0IGFuZCB0YXJnZXQgZm9yIGVhY2ggY29tcG9uZW50XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIG5ld1ZlY3RvcltpXSA9IGxlcnAocHJlc2V0W2ldLCB0YXJnZXRbaV0sIHQpXG4gIH1cblxuICByZXR1cm4gbmV3VmVjdG9yIGFzIFtudW1iZXIsIG51bWJlciwgbnVtYmVyXVxufVxuXG5leHBvcnQgY29uc3QgQ29udHJvbHMgPSAoe1xuICByb3RhdGVTcGVlZCA9IFJPVEFURV9TUEVFRCxcbiAgZW5hYmxlWm9vbSA9IHRydWUsXG4gIGVuYWJsZVJvdGF0ZU9uU2Nyb2xsID0gdHJ1ZSxcbiAgcHJlc2V0LFxuICB0YXJnZXRQcmVzZXQsXG4gIGNoaWxkcmVuLFxuICAuLi5wcm9wc1xufTogTW92ZW1lbnRQcm9wcykgPT4ge1xuICBjb25zdCByZWYgPSB1c2VSZWY8YW55PigpXG4gIGNvbnN0IHNjcm9sbFkgPSB1c2VTY3JvbGxZKClcbiAgY29uc3QgeyBjYW1lcmEsIHNpemUgfSA9IHVzZVRocmVlKClcbiAgY29uc3QgY29udHJvbHMgPSB1c2VSZWY8YW55PigpXG4gIGNvbnN0IFtsb2NrT3JiaXQsIHNldExvY2tPcmJpdF0gPSBSZWFjdC51c2VTdGF0ZShmYWxzZSlcbiAgY29uc3QgW3NjYWxlLCBzZXRTY2FsZV0gPSBSZWFjdC51c2VTdGF0ZSgxKVxuICBjb25zdCBbcG9zWSwgc2V0UG9zWV0gPSBSZWFjdC51c2VTdGF0ZSgwKVxuXG4gIHVzZUZyYW1lKChzdGF0ZSwgZGVsdGEpID0+IHtcbiAgICByZWYuY3VycmVudC5yb3RhdGlvbi55IC09XG4gICAgICBkZWx0YSAqIChpc01vYmlsZSgpID8gMC42ICogcm90YXRlU3BlZWQgOiByb3RhdGVTcGVlZClcbiAgfSlcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNvbnN0IG9uQ2xpY2sgPSAoKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAge1xuICAgICAgICAgICAgY2FtZXJhUG9zOiBjYW1lcmEucG9zaXRpb24udG9BcnJheSgpLFxuICAgICAgICAgICAgY2FtZXJhUm90OiBjYW1lcmEucm90YXRpb24udG9BcnJheSgpLnNsaWNlKDAsIDMpLFxuICAgICAgICAgICAgY29udHJvbHNUYXJnZXQ6IGNvbnRyb2xzLmN1cnJlbnQudGFyZ2V0LnRvQXJyYXkoKSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG51bGwsXG4gICAgICAgICAgMixcbiAgICAgICAgKSxcbiAgICAgIClcbiAgICB9XG5cbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbkNsaWNrKVxuICAgIHJldHVybiAoKSA9PiB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbkNsaWNrKVxuICB9LCBbY2FtZXJhXSlcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChpc1RvdWNoRGV2aWNlKCkpIHtcbiAgICAgIGNvbnRyb2xzLmN1cnJlbnQubWluUG9sYXJBbmdsZSA9IE1hdGguUEkgLyAyXG4gICAgICBjb250cm9scy5jdXJyZW50Lm1heFBvbGFyQW5nbGUgPSBNYXRoLlBJIC8gMlxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHNldExvY2tPcmJpdCh0cnVlKVxuICAgICAgfSwgMTAwMClcbiAgICB9XG4gIH0sIFtdKVxuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKGlzTW9iaWxlKCkpIHtcbiAgICAgIHNldFNjYWxlKG1hcEZsb2F0KHNjcm9sbFksIDAsIGNhbGNTY3JvbGxUaHJlc2hvbGQoKSwgMSwgMC42NSkpXG5cbiAgICAgIHNldFBvc1kobWFwRmxvYXQoc2Nyb2xsWSwgMCwgY2FsY1Njcm9sbFRocmVzaG9sZCgpLCAwLCAwLjM1KSlcbiAgICB9XG4gIH0sIFtzY3JvbGxZXSlcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmICghZW5hYmxlWm9vbSkgcmV0dXJuXG4gICAgaWYgKCF0YXJnZXRQcmVzZXQpIHJldHVyblxuICAgIC8vIHdlIG9ubHkgYXBwbHkgem9vbSBlZmZlY3QgaWYgdGFyZ2V0UHJlc2V0IGlzIGRlZmluZWRcblxuICAgIGNvbnN0IG5ld1BvcyA9IGNhbGN1bGF0ZVZlY3RvcihcbiAgICAgIHNjcm9sbFksXG4gICAgICBNQVhfU0NST0xMLFxuICAgICAgcHJlc2V0LmNhbWVyYVBvcyxcbiAgICAgIHRhcmdldFByZXNldC5jYW1lcmFQb3MsXG4gICAgKVxuICAgIGNvbnN0IG5ld1JvdCA9IGNhbGN1bGF0ZVZlY3RvcihcbiAgICAgIHNjcm9sbFksXG4gICAgICBNQVhfU0NST0xMLFxuICAgICAgcHJlc2V0LmNhbWVyYVJvdCxcbiAgICAgIHRhcmdldFByZXNldC5jYW1lcmFSb3QsXG4gICAgKVxuICAgIGNvbnN0IG5ld1RhcmdldCA9IGNhbGN1bGF0ZVZlY3RvcihcbiAgICAgIHNjcm9sbFksXG4gICAgICBNQVhfU0NST0xMLFxuICAgICAgcHJlc2V0LmNvbnRyb2xzVGFyZ2V0LFxuICAgICAgdGFyZ2V0UHJlc2V0LmNvbnRyb2xzVGFyZ2V0LFxuICAgIClcblxuICAgIGNhbWVyYS5wb3NpdGlvbi5zZXQoLi4ubmV3UG9zKVxuICAgIGNhbWVyYS5yb3RhdGlvbi5zZXQoLi4ubmV3Um90KVxuICAgIGNvbnRyb2xzLmN1cnJlbnQudGFyZ2V0LnNldCguLi5uZXdUYXJnZXQpXG4gICAgY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKVxuICB9LCBbc2Nyb2xsWSwgY2FtZXJhXSlcblxuICByZXR1cm4gKFxuICAgIDxncm91cCByZWY9e3JlZn0gey4uLnByb3BzfSBzY2FsZT17c2NhbGV9IHBvc2l0aW9uLXk9e3Bvc1l9PlxuICAgICAge2NoaWxkcmVufVxuICAgICAgPE9yYml0Q29udHJvbHNcbiAgICAgICAgcmVmPXtjb250cm9sc31cbiAgICAgICAgZW5hYmxlWm9vbT17ZmFsc2V9XG4gICAgICAgIHRhcmdldD17XG4gICAgICAgICAgY29udHJvbHMuY3VycmVudCA/IGNvbnRyb2xzLmN1cnJlbnQudGFyZ2V0IDogcHJlc2V0LmNvbnRyb2xzVGFyZ2V0XG4gICAgICAgIH1cbiAgICAgICAgZW5hYmxlZD17IWxvY2tPcmJpdH1cbiAgICAgIC8+XG4gICAgPC9ncm91cD5cbiAgKVxufVxuIl19
