"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const react_1 = tslib_1.__importStar(require("react"));
const clsx_1 = tslib_1.__importDefault(require("clsx"));
const theme_common_1 = require("@docusaurus/theme-common");
const internal_1 = require("@docusaurus/theme-common/internal");
const Link_1 = tslib_1.__importDefault(require("@docusaurus/Link"));
const Translate_1 = require("@docusaurus/Translate");
const useIsBrowser_1 = tslib_1.__importDefault(require("@docusaurus/useIsBrowser"));
const DocSidebarItems_1 = tslib_1.__importDefault(require("@theme/DocSidebarItems"));
const lsd_react_1 = require("@acid-info/lsd-react");
// If we navigate to a category and it becomes active, it should automatically
// expand itself
function useAutoExpandActiveCategory({ isActive, collapsed, updateCollapsed }) {
    const wasActive = (0, theme_common_1.usePrevious)(isActive);
    (0, react_1.useEffect)(() => {
        const justBecameActive = isActive && !wasActive;
        if (justBecameActive && collapsed) {
            updateCollapsed(false);
        }
    }, [isActive, wasActive, collapsed, updateCollapsed]);
}
/**
 * When a collapsible category has no link, we still link it to its first child
 * during SSR as a temporary fallback. This allows to be able to navigate inside
 * the category even when JS fails to load, is delayed or simply disabled
 * React hydration becomes an optional progressive enhancement
 * see https://github.com/facebookincubator/infima/issues/36#issuecomment-772543188
 * see https://github.com/facebook/docusaurus/issues/3030
 */
function useCategoryHrefWithSSRFallback(item) {
    const isBrowser = (0, useIsBrowser_1.default)();
    return (0, react_1.useMemo)(() => {
        if (item.href) {
            return item.href;
        }
        // In these cases, it's not necessary to render a fallback
        // We skip the "findFirstCategoryLink" computation
        if (isBrowser || !item.collapsible) {
            return undefined;
        }
        return (0, internal_1.findFirstCategoryLink)(item);
    }, [item, isBrowser]);
}
function CollapseButton({ categoryLabel, onClick }) {
    return (react_1.default.createElement("button", { "aria-label": (0, Translate_1.translate)({
            id: 'theme.DocSidebarItem.toggleCollapsedCategoryAriaLabel',
            message: "Toggle the collapsible sidebar category '{label}'",
            description: 'The ARIA label to toggle the collapsible sidebar category',
        }, { label: categoryLabel }), type: "button", className: "clean-btn menu__caret", onClick: onClick }));
}
function DocSidebarItemCategory({ item, onItemClick, activePath, level, index, ...props }) {
    const { items, label, collapsible, className, href } = item;
    const { docs: { sidebar: { autoCollapseCategories }, }, } = (0, theme_common_1.useThemeConfig)();
    const hrefWithSSRFallback = useCategoryHrefWithSSRFallback(item);
    const isActive = (0, internal_1.isActiveSidebarItem)(item, activePath);
    const isCurrentPage = (0, internal_1.isSamePath)(href, activePath);
    const { collapsed, setCollapsed } = (0, theme_common_1.useCollapsible)({
        // Active categories are always initialized as expanded. The default
        // (`item.collapsed`) is only used for non-active categories.
        initialState: () => {
            if (!collapsible) {
                return false;
            }
            return isActive ? false : item.collapsed;
        },
    });
    const { expandedItem, setExpandedItem } = (0, internal_1.useDocSidebarItemsExpandedState)();
    // Use this instead of `setCollapsed`, because it is also reactive
    const updateCollapsed = (toCollapsed = !collapsed) => {
        setExpandedItem(toCollapsed ? null : index);
        setCollapsed(toCollapsed);
    };
    useAutoExpandActiveCategory({ isActive, collapsed, updateCollapsed });
    (0, react_1.useEffect)(() => {
        if (collapsible &&
            expandedItem != null &&
            expandedItem !== index &&
            autoCollapseCategories) {
            setCollapsed(true);
        }
    }, [collapsible, expandedItem, index, setCollapsed, autoCollapseCategories]);
    return (react_1.default.createElement("li", { className: (0, clsx_1.default)(theme_common_1.ThemeClassNames.docs.docSidebarItemCategory, theme_common_1.ThemeClassNames.docs.docSidebarItemCategoryLevel(level), 'menu__list-item', {
            'menu__list-item--collapsed': collapsed,
        }, className) },
        react_1.default.createElement("div", { className: (0, clsx_1.default)('menu__list-item-collapsible', {
                'menu__list-item-collapsible--active': isCurrentPage,
            }) },
            react_1.default.createElement(Link_1.default, { className: (0, clsx_1.default)('menu__link', {
                    'menu__link--sublist': collapsible,
                    'menu__link--active': isActive,
                }), onClick: collapsible
                    ? (e) => {
                        onItemClick?.(item);
                        if (href) {
                            updateCollapsed(false);
                        }
                        else {
                            e.preventDefault();
                            updateCollapsed();
                        }
                    }
                    : () => {
                        onItemClick?.(item);
                    }, "aria-current": isCurrentPage ? 'page' : undefined, "aria-expanded": collapsible ? !collapsed : undefined, href: collapsible ? hrefWithSSRFallback ?? '#' : hrefWithSSRFallback, ...props },
                react_1.default.createElement(lsd_react_1.Typography, { variant: "body2", color: "primary" }, label),
                collapsed ? react_1.default.createElement(lsd_react_1.ArrowUpIcon, null) : react_1.default.createElement(lsd_react_1.ArrowDownIcon, null)),
            href && collapsible && (react_1.default.createElement(CollapseButton, { categoryLabel: label, onClick: (e) => {
                    e.preventDefault();
                    updateCollapsed();
                } }))),
        react_1.default.createElement(theme_common_1.Collapsible, { lazy: true, as: "ul", className: "menu__list", collapsed: collapsed },
            react_1.default.createElement(DocSidebarItems_1.default, { items: items, tabIndex: collapsed ? -1 : 0, onItemClick: onItemClick, activePath: activePath, level: level + 1 }))));
}
exports.default = DocSidebarItemCategory;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGllbnQvdGhlbWUvRG9jU2lkZWJhckl0ZW0vQ2F0ZWdvcnkvaW5kZXgudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHVEQUFpRDtBQUNqRCx3REFBdUI7QUFDdkIsMkRBTWlDO0FBQ2pDLGdFQUswQztBQUMxQyxvRUFBbUM7QUFDbkMscURBQWlEO0FBQ2pELG9GQUFtRDtBQUNuRCxxRkFBb0Q7QUFDcEQsb0RBQTZFO0FBRTdFLDhFQUE4RTtBQUM5RSxnQkFBZ0I7QUFDaEIsU0FBUywyQkFBMkIsQ0FBQyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsZUFBZSxFQUFFO0lBQzNFLE1BQU0sU0FBUyxHQUFHLElBQUEsMEJBQVcsRUFBQyxRQUFRLENBQUMsQ0FBQTtJQUN2QyxJQUFBLGlCQUFTLEVBQUMsR0FBRyxFQUFFO1FBQ2IsTUFBTSxnQkFBZ0IsR0FBRyxRQUFRLElBQUksQ0FBQyxTQUFTLENBQUE7UUFDL0MsSUFBSSxnQkFBZ0IsSUFBSSxTQUFTLEVBQUU7WUFDakMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFBO1NBQ3ZCO0lBQ0gsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQTtBQUN2RCxDQUFDO0FBQ0Q7Ozs7Ozs7R0FPRztBQUVILFNBQVMsOEJBQThCLENBQUMsSUFBSTtJQUMxQyxNQUFNLFNBQVMsR0FBRyxJQUFBLHNCQUFZLEdBQUUsQ0FBQTtJQUNoQyxPQUFPLElBQUEsZUFBTyxFQUFDLEdBQUcsRUFBRTtRQUNsQixJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDYixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUE7U0FDakI7UUFDRCwwREFBMEQ7UUFDMUQsa0RBQWtEO1FBQ2xELElBQUksU0FBUyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNsQyxPQUFPLFNBQVMsQ0FBQTtTQUNqQjtRQUNELE9BQU8sSUFBQSxnQ0FBcUIsRUFB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QUNwQixPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtvQkFDYixDQUFDLENBQUMsY0FBYyxFQUFFLENBQUE7b0JBQ2xCLGVBQWUsRUFBRSxDQUFBO2dCQUNuQixDQUFDLEdBQ0QsQ0FDSCxDQUNHO1FBRU4sOEJBQUMsMEJBQVcsSUFBQyxJQUFJLFFBQUMsRUFBRSxFQUFDLElBQUksRUFBQyxTQUFTLEVBQUMsWUFBWSxFQUFDLFNBQVMsRUFBRSxTQUFTO1lBQ25FLDhCQUFDLHlCQUFlLElBQ2QsS0FBSyxFQUFFLEtBQUssRUFDWixRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUM1QixXQUFXLEVBQUUsV0FBVyxFQUN4QixVQUFVLEVBQUUsVUFBVSxFQUN0QixLQUFLLEVBQUUsS0FBSyxHQUFHLENBQUMsR0FDaEIsQ0FDVSxDQUNYLENBQ04sQ0FBQTtBQUNILENBQUM7QUF2SEQseUNBdUhDIiwiZmlsZSI6ImNsaWVudC90aGVtZS9Eb2NTaWRlYmFySXRlbS9DYXRlZ29yeS9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyB1c2VFZmZlY3QsIHVzZU1lbW8gfSBmcm9tICdyZWFjdCdcbmltcG9ydCBjbHN4IGZyb20gJ2Nsc3gnXG5pbXBvcnQge1xuICBUaGVtZUNsYXNzTmFtZXMsXG4gIHVzZVRoZW1lQ29uZmlnLFxuICB1c2VQcmV2aW91cyxcbiAgQ29sbGFwc2libGUsXG4gIHVzZUNvbGxhcHNpYmxlLFxufSBmcm9tICdAZG9jdXNhdXJ1cy90aGVtZS1jb21tb24nXG5pbXBvcnQge1xuICBpc0FjdGl2ZVNpZGViYXJJdGVtLFxuICBmaW5kRmlyc3RDYXRlZ29yeUxpbmssXG4gIHVzZURvY1NpZGViYXJJdGVtc0V4cGFuZGVkU3RhdGUsXG4gIGlzU2FtZVBhdGgsXG59IGZyb20gJ0Bkb2N1c2F1cnVzL3RoZW1lLWNvbW1vbi9pbnRlcm5hbCdcbmltcG9ydCBMaW5rIGZyb20gJ0Bkb2N1c2F1cnVzL0xpbmsnXG5pbXBvcnQgeyB0cmFuc2xhdGUgfSBmcm9tICdAZG9jdXNhdXJ1cy9UcmFuc2xhdGUnXG5pbXBvcnQgdXNlSXNCcm93c2VyIGZyb20gJ0Bkb2N1c2F1cnVzL3VzZUlzQnJvd3NlcidcbmltcG9ydCBEb2NTaWRlYmFySXRlbXMgZnJvbSAnQHRoZW1lL0RvY1NpZGViYXJJdGVtcydcbmltcG9ydCB7IEFycm93RG93bkljb24sIEFycm93VXBJY29uLCBUeXBvZ3JhcGh5IH0gZnJvbSAnQGFjaWQtaW5mby9sc2QtcmVhY3QnXG5cbi8vIElmIHdlIG5hdmlnYXRlIHRvIGEgY2F0ZWdvcnkgYW5kIGl0IGJlY29tZXMgYWN0aXZlLCBpdCBzaG91bGQgYXV0b21hdGljYWxseVxuLy8gZXhwYW5kIGl0c2VsZlxuZnVuY3Rpb24gdXNlQXV0b0V4cGFuZEFjdGl2ZUNhdGVnb3J5KHsgaXNBY3RpdmUsIGNvbGxhcHNlZCwgdXBkYXRlQ29sbGFwc2VkIH0pIHtcbiAgY29uc3Qgd2FzQWN0aXZlID0gdXNlUHJldmlvdXMoaXNBY3RpdmUpXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgY29uc3QganVzdEJlY2FtZUFjdGl2ZSA9IGlzQWN0aXZlICYmICF3YXNBY3RpdmVcbiAgICBpZiAoanVzdEJlY2FtZUFjdGl2ZSAmJiBjb2xsYXBzZWQpIHtcbiAgICAgIHVwZGF0ZUNvbGxhcHNlZChmYWxzZSlcbiAgICB9XG4gIH0sIFtpc0FjdGl2ZSwgd2FzQWN0aXZlLCBjb2xsYXBzZWQsIHVwZGF0ZUNvbGxhcHNlZF0pXG59XG4vKipcbiAqIFdoZW4gYSBjb2xsYXBzaWJsZSBjYXRlZ29yeSBoYXMgbm8gbGluaywgd2Ugc3RpbGwgbGluayBpdCB0byBpdHMgZmlyc3QgY2hpbGRcbiAqIGR1cmluZyBTU1IgYXMgYSB0ZW1wb3JhcnkgZmFsbGJhY2suIFRoaXMgYWxsb3dzIHRvIGJlIGFibGUgdG8gbmF2aWdhdGUgaW5zaWRlXG4gKiB0aGUgY2F0ZWdvcnkgZXZlbiB3aGVuIEpTIGZhaWxzIHRvIGxvYWQsIGlzIGRlbGF5ZWQgb3Igc2ltcGx5IGRpc2FibGVkXG4gKiBSZWFjdCBoeWRyYXRpb24gYmVjb21lcyBhbiBvcHRpb25hbCBwcm9ncmVzc2l2ZSBlbmhhbmNlbWVudFxuICogc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9va2luY3ViYXRvci9pbmZpbWEvaXNzdWVzLzM2I2lzc3VlY29tbWVudC03NzI1NDMxODhcbiAqIHNlZSBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svZG9jdXNhdXJ1cy9pc3N1ZXMvMzAzMFxuICovXG5cbmZ1bmN0aW9uIHVzZUNhdGVnb3J5SHJlZldpdGhTU1JGYWxsYmFjayhpdGVtKSB7XG4gIGNvbnN0IGlzQnJvd3NlciA9IHVzZUlzQnJvd3NlcigpXG4gIHJldHVybiB1c2VNZW1vKCgpID0+IHtcbiAgICBpZiAoaXRlbS5ocmVmKSB7XG4gICAgICByZXR1cm4gaXRlbS5ocmVmXG4gICAgfVxuICAgIC8vIEluIHRoZXNlIGNhc2VzLCBpdCdzIG5vdCBuZWNlc3NhcnkgdG8gcmVuZGVyIGEgZmFsbGJhY2tcbiAgICAvLyBXZSBza2lwIHRoZSBcImZpbmRGaXJzdENhdGVnb3J5TGlua1wiIGNvbXB1dGF0aW9uXG4gICAgaWYgKGlzQnJvd3NlciB8fCAhaXRlbS5jb2xsYXBzaWJsZSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cbiAgICByZXR1cm4gZmluZEZpcnN0Q2F0ZWdvcnlMaW5rKGl0ZW0pXG4gIH0sIFtpdGVtLCBpc0Jyb3dzZXJdKVxufVxuXG5mdW5jdGlvbiBDb2xsYXBzZUJ1dHRvbih7IGNhdGVnb3J5TGFiZWwsIG9uQ2xpY2sgfSkge1xuICByZXR1cm4gKFxuICAgIDxidXR0b25cbiAgICAgIGFyaWEtbGFiZWw9e3RyYW5zbGF0ZShcbiAgICAgICAge1xuICAgICAgICAgIGlkOiAndGhlbWUuRG9jU2lkZWJhckl0ZW0udG9nZ2xlQ29sbGFwc2VkQ2F0ZWdvcnlBcmlhTGFiZWwnLFxuICAgICAgICAgIG1lc3NhZ2U6IFwiVG9nZ2xlIHRoZSBjb2xsYXBzaWJsZSBzaWRlYmFyIGNhdGVnb3J5ICd7bGFiZWx9J1wiLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOlxuICAgICAgICAgICAgJ1RoZSBBUklBIGxhYmVsIHRvIHRvZ2dsZSB0aGUgY29sbGFwc2libGUgc2lkZWJhciBjYXRlZ29yeScsXG4gICAgICAgIH0sXG4gICAgICAgIHsgbGFiZWw6IGNhdGVnb3J5TGFiZWwgfSxcbiAgICAgICl9XG4gICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgIGNsYXNzTmFtZT1cImNsZWFuLWJ0biBtZW51X19jYXJldFwiXG4gICAgICBvbkNsaWNrPXtvbkNsaWNrfVxuICAgIC8+XG4gIClcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gRG9jU2lkZWJhckl0ZW1DYXRlZ29yeSh7XG4gIGl0ZW0sXG4gIG9uSXRlbUNsaWNrLFxuICBhY3RpdmVQYXRoLFxuICBsZXZlbCxcbiAgaW5kZXgsXG4gIC4uLnByb3BzXG59KSB7XG4gIGNvbnN0IHsgaXRlbXMsIGxhYmVsLCBjb2xsYXBzaWJsZSwgY2xhc3NOYW1lLCBocmVmIH0gPSBpdGVtXG4gIGNvbnN0IHtcbiAgICBkb2NzOiB7XG4gICAgICBzaWRlYmFyOiB7IGF1dG9Db2xsYXBzZUNhdGVnb3JpZXMgfSxcbiAgICB9LFxuICB9ID0gdXNlVGhlbWVDb25maWcoKVxuICBjb25zdCBocmVmV2l0aFNTUkZhbGxiYWNrID0gdXNlQ2F0ZWdvcnlIcmVmV2l0aFNTUkZhbGxiYWNrKGl0ZW0pXG4gIGNvbnN0IGlzQWN0aXZlID0gaXNBY3RpdmVTaWRlYmFySXRlbShpdGVtLCBhY3RpdmVQYXRoKVxuICBjb25zdCBpc0N1cnJlbnRQYWdlID0gaXNTYW1lUGF0aChocmVmLCBhY3RpdmVQYXRoKVxuXG4gIGNvbnN0IHsgY29sbGFwc2VkLCBzZXRDb2xsYXBzZWQgfSA9IHVzZUNvbGxhcHNpYmxlKHtcbiAgICAvLyBBY3RpdmUgY2F0ZWdvcmllcyBhcmUgYWx3YXlzIGluaXRpYWxpemVkIGFzIGV4cGFuZGVkLiBUaGUgZGVmYXVsdFxuICAgIC8vIChgaXRlbS5jb2xsYXBzZWRgKSBpcyBvbmx5IHVzZWQgZm9yIG5vbi1hY3RpdmUgY2F0ZWdvcmllcy5cbiAgICBpbml0aWFsU3RhdGU6ICgpID0+IHtcbiAgICAgIGlmICghY29sbGFwc2libGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG4gICAgICByZXR1cm4gaXNBY3RpdmUgPyBmYWxzZSA6IGl0ZW0uY29sbGFwc2VkXG4gICAgfSxcbiAgfSlcblxuICBjb25zdCB7IGV4cGFuZGVkSXRlbSwgc2V0RXhwYW5kZWRJdGVtIH0gPSB1c2VEb2NTaWRlYmFySXRlbXNFeHBhbmRlZFN0YXRlKClcblxuICAvLyBVc2UgdGhpcyBpbnN0ZWFkIG9mIGBzZXRDb2xsYXBzZWRgLCBiZWNhdXNlIGl0IGlzIGFsc28gcmVhY3RpdmVcbiAgY29uc3QgdXBkYXRlQ29sbGFwc2VkID0gKHRvQ29sbGFwc2VkID0gIWNvbGxhcHNlZCkgPT4ge1xuICAgIHNldEV4cGFuZGVkSXRlbSh0b0NvbGxhcHNlZCA/IG51bGwgOiBpbmRleClcbiAgICBzZXRDb2xsYXBzZWQodG9Db2xsYXBzZWQpXG4gIH1cblxuICB1c2VBdXRvRXhwYW5kQWN0aXZlQ2F0ZWdvcnkoeyBpc0FjdGl2ZSwgY29sbGFwc2VkLCB1cGRhdGVDb2xsYXBzZWQgfSlcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChcbiAgICAgIGNvbGxhcHNpYmxlICYmXG4gICAgICBleHBhbmRlZEl0ZW0gIT0gbnVsbCAmJlxuICAgICAgZXhwYW5kZWRJdGVtICE9PSBpbmRleCAmJlxuICAgICAgYXV0b0NvbGxhcHNlQ2F0ZWdvcmllc1xuICAgICkge1xuICAgICAgc2V0Q29sbGFwc2VkKHRydWUpXG4gICAgfVxuICB9LCBbY29sbGFwc2libGUsIGV4cGFuZGVkSXRlbSwgaW5kZXgsIHNldENvbGxhcHNlZCwgYXV0b0NvbGxhcHNlQ2F0ZWdvcmllc10pXG5cbiAgcmV0dXJuIChcbiAgICA8bGlcbiAgICAgIGNsYXNzTmFtZT17Y2xzeChcbiAgICAgICAgVGhlbWVDbGFzc05hbWVzLmRvY3MuZG9jU2lkZWJhckl0ZW1DYXRlZ29yeSxcbiAgICAgICAgVGhlbWVDbGFzc05hbWVzLmRvY3MuZG9jU2lkZWJhckl0ZW1DYXRlZ29yeUxldmVsKGxldmVsKSxcbiAgICAgICAgJ21lbnVfX2xpc3QtaXRlbScsXG4gICAgICAgIHtcbiAgICAgICAgICAnbWVudV9fbGlzdC1pdGVtLS1jb2xsYXBzZWQnOiBjb2xsYXBzZWQsXG4gICAgICAgIH0sXG4gICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICl9XG4gICAgPlxuICAgICAgPGRpdlxuICAgICAgICBjbGFzc05hbWU9e2Nsc3goJ21lbnVfX2xpc3QtaXRlbS1jb2xsYXBzaWJsZScsIHtcbiAgICAgICAgICAnbWVudV9fbGlzdC1pdGVtLWNvbGxhcHNpYmxlLS1hY3RpdmUnOiBpc0N1cnJlbnRQYWdlLFxuICAgICAgICB9KX1cbiAgICAgID5cbiAgICAgICAgPExpbmtcbiAgICAgICAgICBjbGFzc05hbWU9e2Nsc3goJ21lbnVfX2xpbmsnLCB7XG4gICAgICAgICAgICAnbWVudV9fbGluay0tc3VibGlzdCc6IGNvbGxhcHNpYmxlLFxuICAgICAgICAgICAgJ21lbnVfX2xpbmstLWFjdGl2ZSc6IGlzQWN0aXZlLFxuICAgICAgICAgIH0pfVxuICAgICAgICAgIG9uQ2xpY2s9e1xuICAgICAgICAgICAgY29sbGFwc2libGVcbiAgICAgICAgICAgICAgPyAoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgb25JdGVtQ2xpY2s/LihpdGVtKVxuICAgICAgICAgICAgICAgICAgaWYgKGhyZWYpIHtcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlQ29sbGFwc2VkKGZhbHNlKVxuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZUNvbGxhcHNlZCgpXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgIG9uSXRlbUNsaWNrPy4oaXRlbSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGFyaWEtY3VycmVudD17aXNDdXJyZW50UGFnZSA/ICdwYWdlJyA6IHVuZGVmaW5lZH1cbiAgICAgICAgICBhcmlhLWV4cGFuZGVkPXtjb2xsYXBzaWJsZSA/ICFjb2xsYXBzZWQgOiB1bmRlZmluZWR9XG4gICAgICAgICAgaHJlZj17Y29sbGFwc2libGUgPyBocmVmV2l0aFNTUkZhbGxiYWNrID8/ICcjJyA6IGhyZWZXaXRoU1NSRmFsbGJhY2t9XG4gICAgICAgICAgey4uLnByb3BzfVxuICAgICAgICA+XG4gICAgICAgICAgPFR5cG9ncmFwaHkgdmFyaWFudD1cImJvZHkyXCIgY29sb3I9XCJwcmltYXJ5XCI+XG4gICAgICAgICAgICB7bGFiZWx9XG4gICAgICAgICAgPC9UeXBvZ3JhcGh5PlxuICAgICAgICAgIHtjb2xsYXBzZWQgPyA8QXJyb3dVcEljb24gLz4gOiA8QXJyb3dEb3duSWNvbiAvPn1cbiAgICAgICAgPC9MaW5rPlxuICAgICAgICB7aHJlZiAmJiBjb2xsYXBzaWJsZSAmJiAoXG4gICAgICAgICAgPENvbGxhcHNlQnV0dG9uXG4gICAgICAgICAgICBjYXRlZ29yeUxhYmVsPXtsYWJlbH1cbiAgICAgICAgICAgIG9uQ2xpY2s9eyhlKSA9PiB7XG4gICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKVxuICAgICAgICAgICAgICB1cGRhdGVDb2xsYXBzZWQoKVxuICAgICAgICAgICAgfX1cbiAgICAgICAgICAvPlxuICAgICAgICApfVxuICAgICAgPC9kaXY+XG5cbiAgICAgIDxDb2xsYXBzaWJsZSBsYXp5IGFzPVwidWxcIiBjbGFzc05hbWU9XCJtZW51X19saXN0XCIgY29sbGFwc2VkPXtjb2xsYXBzZWR9PlxuICAgICAgICA8RG9jU2lkZWJhckl0ZW1zXG4gICAgICAgICAgaXRlbXM9e2l0ZW1zfVxuICAgICAgICAgIHRhYkluZGV4PXtjb2xsYXBzZWQgPyAtMSA6IDB9XG4gICAgICAgICAgb25JdGVtQ2xpY2s9e29uSXRlbUNsaWNrfVxuICAgICAgICAgIGFjdGl2ZVBhdGg9e2FjdGl2ZVBhdGh9XG4gICAgICAgICAgbGV2ZWw9e2xldmVsICsgMX1cbiAgICAgICAgLz5cbiAgICAgIDwvQ29sbGFwc2libGU+XG4gICAgPC9saT5cbiAgKVxufVxuIl19
